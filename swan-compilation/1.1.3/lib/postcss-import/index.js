/* eslint-disable */
"use strict";
// builtin tooling

var path = require("path");

// external tooling
var postcss = require("postcss");

// internal tooling
var joinMedia = require("./lib/join-media");
var resolveId = require("./lib/resolve-id");
var loadContent = require("./lib/load-content");
var processContent = require("./lib/process-content");
var parseStatements = require("./lib/parse-statements");

function AtImport(options) {
  options = Object.assign({
    root: process.cwd(),
    path: [],
    skipDuplicates: true,
    resolve: resolveId,
    load: loadContent,
    plugins: [],
    addModulesDirectories: []
  }, options);

  options.root = path.resolve(options.root);

  // convert string to an array of a single element
  if (typeof options.path === "string") options.path = [options.path];

  if (!Array.isArray(options.path)) options.path = [];

  options.path = options.path.map(function (p) {
    return path.resolve(options.root, p);
  });

  return function (styles, result) {
    var state = {
      importedFiles: {},
      hashFiles: {}
    };

    if (styles.source && styles.source.input && styles.source.input.file) {
      state.importedFiles[styles.source.input.file] = {};
    }

    if (options.plugins && !Array.isArray(options.plugins)) {
      throw new Error("plugins option must be an array");
    }

    return parseStyles(result, styles, options, state, []).then(function (bundle) {
      applyRaws(bundle);
      applyMedia(bundle);
      applyStyles(bundle, styles);
    });
  };
}

function applyRaws(bundle) {
  bundle.forEach(function (stmt, index) {
    if (index === 0) return;

    if (stmt.parent) {
      var before = stmt.parent.node.raws.before;
      if (stmt.type === "nodes") stmt.nodes[0].raws.before = before;else stmt.node.raws.before = before;
    } else if (stmt.type === "nodes") {
      stmt.nodes[0].raws.before = stmt.nodes[0].raws.before || "\n";
    }
  });
}

function applyMedia(bundle) {
  bundle.forEach(function (stmt) {
    if (!stmt.media.length) return;
    if (stmt.type === "import") {
      stmt.node.params = stmt.fullUri + " " + stmt.media.join(", ");
    } else if (stmt.type === "media") stmt.node.params = stmt.media.join(", ");else {
      var nodes = stmt.nodes;
      var parent = nodes[0].parent;
      var mediaNode = postcss.atRule({
        name: "media",
        params: stmt.media.join(", "),
        source: parent.source
      });

      parent.insertBefore(nodes[0], mediaNode);

      // remove nodes
      nodes.forEach(function (node) {
        node.parent = undefined;
      });

      // better output
      nodes[0].raws.before = nodes[0].raws.before || "\n";

      // wrap new rules with media query
      mediaNode.append(nodes);

      stmt.type = "media";
      stmt.node = mediaNode;
      delete stmt.nodes;
    }
  });
}

function applyStyles(bundle, styles) {
  styles.nodes = [];

  // Strip additional statements.
  bundle.forEach(function (stmt) {
    if (stmt.type === "import") {
      stmt.node.parent = undefined;
      styles.append(stmt.node);
    } else if (stmt.type === "media") {
      stmt.node.parent = undefined;
      styles.append(stmt.node);
    } else if (stmt.type === "nodes") {
      stmt.nodes.forEach(function (node) {
        node.parent = undefined;
        styles.append(node);
      });
    }
  });
}

function parseStyles(result, styles, options, state, media) {
  var statements = parseStatements(result, styles);

  return Promise.resolve(statements).then(function (stmts) {
    // process each statement in series
    return stmts.reduce(function (promise, stmt) {
      return promise.then(function () {
        stmt.media = joinMedia(media, stmt.media || []);

        // skip protocol base uri (protocol://url) or protocol-relative
        if (stmt.type !== "import" || /^(?:[a-z]+:)?\/\//i.test(stmt.uri)) {
          return;
        }

        if (options.filter && !options.filter(stmt.uri)) {
          // rejected by filter
          return;
        }

        return resolveImportId(result, stmt, options, state);
      });
    }, Promise.resolve());
  }).then(function () {
    var imports = [];
    var bundle = [];

    // squash statements and their children
    statements.forEach(function (stmt) {
      if (stmt.type === "import") {
        if (stmt.children) {
          stmt.children.forEach(function (child, index) {
            if (child.type === "import") imports.push(child);else bundle.push(child);
            // For better output
            if (index === 0) child.parent = stmt;
          });
        } else imports.push(stmt);
      } else if (stmt.type === "media" || stmt.type === "nodes") {
        bundle.push(stmt);
      }
    });

    return imports.concat(bundle);
  });
}

function resolveImportId(result, stmt, options, state) {
  var atRule = stmt.node;
  var sourceFile = void 0;
  if (atRule.source && atRule.source.input && atRule.source.input.file) {
    sourceFile = atRule.source.input.file;
  }
  var base = sourceFile ? path.dirname(atRule.source.input.file) : options.root;

  return Promise.resolve(options.resolve(stmt.uri, base, options)).then(function (paths) {
    if (!Array.isArray(paths)) paths = [paths];
    // Ensure that each path is absolute:
    return Promise.all(paths.map(function (file) {
      return !path.isAbsolute(file) ? resolveId(file, base, options) : file;
    }));
  }).then(function (resolved) {
    // Add dependency messages:
    resolved.forEach(function (file) {
      result.messages.push({
        type: "dependency",
        file: file,
        parent: sourceFile
      });
    });

    return Promise.all(resolved.map(function (file) {
      return loadImportContent(result, stmt, file, options, state);
    }));
  }).then(function (result) {
    // Merge loaded statements
    stmt.children = result.reduce(function (result, statements) {
      return statements ? result.concat(statements) : result;
    }, []);
  });
}

function loadImportContent(result, stmt, filename, options, state) {
  var atRule = stmt.node;
  var media = stmt.media;
  if (options.skipDuplicates) {
    // skip files already imported at the same scope
    if (state.importedFiles[filename] && state.importedFiles[filename][media]) {
      return;
    }

    // save imported files to skip them next time
    if (!state.importedFiles[filename]) state.importedFiles[filename] = {};
    state.importedFiles[filename][media] = true;
  }

  return Promise.resolve(options.load(filename, options)).then(function (content) {
    if (content.trim() === "") {
      result.warn(filename + " is empty", { node: atRule });
      return;
    }

    // skip previous imported files not containing @import rules
    if (state.hashFiles[content] && state.hashFiles[content][media]) return;

    return processContent(result, content, filename, options).then(function (importedResult) {
      var styles = importedResult.root;
      result.messages = result.messages.concat(importedResult.messages);

      if (options.skipDuplicates) {
        var hasImport = styles.some(function (child) {
          return child.type === "atrule" && child.name === "import";
        });
        if (!hasImport) {
          // save hash files to skip them next time
          if (!state.hashFiles[content]) state.hashFiles[content] = {};
          state.hashFiles[content][media] = true;
        }
      }

      // recursion: import @import from imported file
      return parseStyles(result, styles, options, state, media);
    });
  });
}

module.exports = postcss.plugin("postcss-import", AtImport);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wb3N0Y3NzLWltcG9ydC9pbmRleC5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsInBvc3Rjc3MiLCJqb2luTWVkaWEiLCJyZXNvbHZlSWQiLCJsb2FkQ29udGVudCIsInByb2Nlc3NDb250ZW50IiwicGFyc2VTdGF0ZW1lbnRzIiwiQXRJbXBvcnQiLCJvcHRpb25zIiwiT2JqZWN0IiwiYXNzaWduIiwicm9vdCIsInByb2Nlc3MiLCJjd2QiLCJza2lwRHVwbGljYXRlcyIsInJlc29sdmUiLCJsb2FkIiwicGx1Z2lucyIsImFkZE1vZHVsZXNEaXJlY3RvcmllcyIsIkFycmF5IiwiaXNBcnJheSIsIm1hcCIsInAiLCJzdHlsZXMiLCJyZXN1bHQiLCJzdGF0ZSIsImltcG9ydGVkRmlsZXMiLCJoYXNoRmlsZXMiLCJzb3VyY2UiLCJpbnB1dCIsImZpbGUiLCJFcnJvciIsInBhcnNlU3R5bGVzIiwidGhlbiIsImFwcGx5UmF3cyIsImJ1bmRsZSIsImFwcGx5TWVkaWEiLCJhcHBseVN0eWxlcyIsImZvckVhY2giLCJzdG10IiwiaW5kZXgiLCJwYXJlbnQiLCJiZWZvcmUiLCJub2RlIiwicmF3cyIsInR5cGUiLCJub2RlcyIsIm1lZGlhIiwibGVuZ3RoIiwicGFyYW1zIiwiZnVsbFVyaSIsImpvaW4iLCJtZWRpYU5vZGUiLCJhdFJ1bGUiLCJuYW1lIiwiaW5zZXJ0QmVmb3JlIiwidW5kZWZpbmVkIiwiYXBwZW5kIiwic3RhdGVtZW50cyIsIlByb21pc2UiLCJzdG10cyIsInJlZHVjZSIsInByb21pc2UiLCJ0ZXN0IiwidXJpIiwiZmlsdGVyIiwicmVzb2x2ZUltcG9ydElkIiwiaW1wb3J0cyIsImNoaWxkcmVuIiwiY2hpbGQiLCJwdXNoIiwiY29uY2F0Iiwic291cmNlRmlsZSIsImJhc2UiLCJkaXJuYW1lIiwicGF0aHMiLCJhbGwiLCJpc0Fic29sdXRlIiwicmVzb2x2ZWQiLCJtZXNzYWdlcyIsImxvYWRJbXBvcnRDb250ZW50IiwiZmlsZW5hbWUiLCJjb250ZW50IiwidHJpbSIsIndhcm4iLCJpbXBvcnRlZFJlc3VsdCIsImhhc0ltcG9ydCIsInNvbWUiLCJtb2R1bGUiLCJleHBvcnRzIiwicGx1Z2luIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7O0FBQ0EsSUFBTUEsT0FBT0MsUUFBUSxNQUFSLENBQWI7O0FBRUE7QUFDQSxJQUFNQyxVQUFVRCxRQUFRLFNBQVIsQ0FBaEI7O0FBRUE7QUFDQSxJQUFNRSxZQUFZRixRQUFRLGtCQUFSLENBQWxCO0FBQ0EsSUFBTUcsWUFBWUgsUUFBUSxrQkFBUixDQUFsQjtBQUNBLElBQU1JLGNBQWNKLFFBQVEsb0JBQVIsQ0FBcEI7QUFDQSxJQUFNSyxpQkFBaUJMLFFBQVEsdUJBQVIsQ0FBdkI7QUFDQSxJQUFNTSxrQkFBa0JOLFFBQVEsd0JBQVIsQ0FBeEI7O0FBRUEsU0FBU08sUUFBVCxDQUFrQkMsT0FBbEIsRUFBMkI7QUFDekJBLFlBQVVDLE9BQU9DLE1BQVAsQ0FDUjtBQUNFQyxVQUFNQyxRQUFRQyxHQUFSLEVBRFI7QUFFRWQsVUFBTSxFQUZSO0FBR0VlLG9CQUFnQixJQUhsQjtBQUlFQyxhQUFTWixTQUpYO0FBS0VhLFVBQU1aLFdBTFI7QUFNRWEsYUFBUyxFQU5YO0FBT0VDLDJCQUF1QjtBQVB6QixHQURRLEVBVVJWLE9BVlEsQ0FBVjs7QUFhQUEsVUFBUUcsSUFBUixHQUFlWixLQUFLZ0IsT0FBTCxDQUFhUCxRQUFRRyxJQUFyQixDQUFmOztBQUVBO0FBQ0EsTUFBSSxPQUFPSCxRQUFRVCxJQUFmLEtBQXdCLFFBQTVCLEVBQXNDUyxRQUFRVCxJQUFSLEdBQWUsQ0FBQ1MsUUFBUVQsSUFBVCxDQUFmOztBQUV0QyxNQUFJLENBQUNvQixNQUFNQyxPQUFOLENBQWNaLFFBQVFULElBQXRCLENBQUwsRUFBa0NTLFFBQVFULElBQVIsR0FBZSxFQUFmOztBQUVsQ1MsVUFBUVQsSUFBUixHQUFlUyxRQUFRVCxJQUFSLENBQWFzQixHQUFiLENBQWlCO0FBQUEsV0FBS3RCLEtBQUtnQixPQUFM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RCxRQUFQLEdBQWtCdkQsT0FBT3VELFFBQVAsQ0FBZ0JSLE1BQWhCLENBQXVCYyxlQUFlTixRQUF0QyxDQUFsQjs7QUFFQSxVQUFJdkUsUUFBUU0sY0FBWixFQUE0QjtBQUMxQixZQUFNd0UsWUFBWS9ELE9BQU9nRSxJQUFQLENBQVksaUJBQVM7QUFDckMsaUJBQU9sQixNQUFNeEIsSUFBTixLQUFlLFFBQWYsSUFBMkJ3QixNQUFNZixJQUFOLEtBQWUsUUFBakQ7QUFDRCxTQUZpQixDQUFsQjtBQUdBLFlBQUksQ0FBQ2dDLFNBQUwsRUFBZ0I7QUFDZDtBQUNBLGNBQUksQ0FBQzdELE1BQU1FLFNBQU4sQ0FBZ0J1RCxPQUFoQixDQUFMLEVBQStCekQsTUFBTUUsU0FBTixDQUFnQnVELE9BQWhCLElBQTJCLEVBQTNCO0FBQy9CekQsZ0JBQU1FLFNBQU4sQ0FBZ0J1RCxPQUFoQixFQUF5Qm5DLEtBQXpCLElBQWtDLElBQWxDO0FBQ0Q7QUFDRjs7QUFFRDtBQUNBLGFBQU9mLFlBQVlSLE1BQVosRUFBb0JELE1BQXBCLEVBQTRCZixPQUE1QixFQUFxQ2lCLEtBQXJDLEVBQTRDc0IsS0FBNUMsQ0FBUDtBQUNELEtBbEJJLENBQVA7QUFvQkQsR0E3Qk0sQ0FBUDtBQThCRDs7QUFFRHlDLE9BQU9DLE9BQVAsR0FBaUJ4RixRQUFReUYsTUFBUixDQUFlLGdCQUFmLEVBQWlDbkYsUUFBakMsQ0FBakIiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSAqL1xuXCJ1c2Ugc3RyaWN0XCJcbi8vIGJ1aWx0aW4gdG9vbGluZ1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpXG5cbi8vIGV4dGVybmFsIHRvb2xpbmdcbmNvbnN0IHBvc3Rjc3MgPSByZXF1aXJlKFwicG9zdGNzc1wiKVxuXG4vLyBpbnRlcm5hbCB0b29saW5nXG5jb25zdCBqb2luTWVkaWEgPSByZXF1aXJlKFwiLi9saWIvam9pbi1tZWRpYVwiKVxuY29uc3QgcmVzb2x2ZUlkID0gcmVxdWlyZShcIi4vbGliL3Jlc29sdmUtaWRcIilcbmNvbnN0IGxvYWRDb250ZW50ID0gcmVxdWlyZShcIi4vbGliL2xvYWQtY29udGVudFwiKVxuY29uc3QgcHJvY2Vzc0NvbnRlbnQgPSByZXF1aXJlKFwiLi9saWIvcHJvY2Vzcy1jb250ZW50XCIpXG5jb25zdCBwYXJzZVN0YXRlbWVudHMgPSByZXF1aXJlKFwiLi9saWIvcGFyc2Utc3RhdGVtZW50c1wiKVxuXG5mdW5jdGlvbiBBdEltcG9ydChvcHRpb25zKSB7XG4gIG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKFxuICAgIHtcbiAgICAgIHJvb3Q6IHByb2Nlc3MuY3dkKCksXG4gICAgICBwYXRoOiBbXSxcbiAgICAgIHNraXBEdXBsaWNhdGVzOiB0cnVlLFxuICAgICAgcmVzb2x2ZTogcmVzb2x2ZUlkLFxuICAgICAgbG9hZDogbG9hZENvbnRlbnQsXG4gICAgICBwbHVnaW5zOiBbXSxcbiAgICAgIGFkZE1vZHVsZXNEaXJlY3RvcmllczogW10sXG4gICAgfSxcbiAgICBvcHRpb25zXG4gIClcblxuICBvcHRpb25zLnJvb3QgPSBwYXRoLnJlc29sdmUob3B0aW9ucy5yb290KVxuXG4gIC8vIGNvbnZlcnQgc3RyaW5nIHRvIGFuIGFycmF5IG9mIGEgc2luZ2xlIGVsZW1lbnRcbiAgaWYgKHR5cGVvZiBvcHRpb25zLnBhdGggPT09IFwic3RyaW5nXCIpIG9wdGlvbnMucGF0aCA9IFtvcHRpb25zLnBhdGhdXG5cbiAgaWYgKCFBcnJheS5pc0FycmF5KG9wdGlvbnMucGF0aCkpIG9wdGlvbnMucGF0aCA9IFtdXG5cbiAgb3B0aW9ucy5wYXRoID0gb3B0aW9ucy5wYXRoLm1hcChwID0+IHBhdGgucmVzb2x2ZShvcHRpb25zLnJvb3QsIHApKVxuXG4gIHJldHVybiBmdW5jdGlvbihzdHlsZXMsIHJlc3VsdCkge1xuICAgIGNvbnN0IHN0YXRlID0ge1xuICAgICAgaW1wb3J0ZWRGaWxlczoge30sXG4gICAgICBoYXNoRmlsZXM6IHt9LFxuICAgIH1cblxuICAgIGlmIChzdHlsZXMuc291cmNlICYmIHN0eWxlcy5zb3VyY2UuaW5wdXQgJiYgc3R5bGVzLnNvdXJjZS5pbnB1dC5maWxlKSB7XG4gICAgICBzdGF0ZS5pbXBvcnRlZEZpbGVzW3N0eWxlcy5zb3VyY2UuaW5wdXQuZmlsZV0gPSB7fVxuICAgIH1cblxuICAgIGlmIChvcHRpb25zLnBsdWdpbnMgJiYgIUFycmF5LmlzQXJyYXkob3B0aW9ucy5wbHVnaW5zKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwicGx1Z2lucyBvcHRpb24gbXVzdCBiZSBhbiBhcnJheVwiKVxuICAgIH1cblxuICAgIHJldHVybiBwYXJzZVN0eWxlcyhyZXN1bHQsIHN0eWxlcywgb3B0aW9ucywgc3RhdGUsIFtdKS50aGVuKGJ1bmRsZSA9PiB7XG4gICAgICBhcHBseVJhd3MoYnVuZGxlKVxuICAgICAgYXBwbHlNZWRpYShidW5kbGUpXG4gICAgICBhcHBseVN0eWxlcyhidW5kbGUsIHN0eWxlcylcbiAgICB9KVxuICB9XG59XG5cbmZ1bmN0aW9uIGFwcGx5UmF3cyhidW5kbGUpIHtcbiAgYnVuZGxlLmZvckVhY2goKHN0bXQsIGluZGV4KSA9PiB7XG4gICAgaWYgKGluZGV4ID09PSAwKSByZXR1cm5cblxuICAgIGlmIChzdG10LnBhcmVudCkge1xuICAgICAgY29uc3QgYmVmb3JlID0gc3RtdC5wYXJlbnQubm9kZS5yYXdzLmJlZm9yZVxuICAgICAgaWYgKHN0bXQudHlwZSA9PT0gXCJub2Rlc1wiKSBzdG10Lm5vZGVzWzBdLnJhd3MuYmVmb3JlID0gYmVmb3JlXG4gICAgICBlbHNlIHN0bXQubm9kZS5yYXdzLmJlZm9yZSA9IGJlZm9yZVxuICAgIH0gZWxzZSBpZiAoc3RtdC50eXBlID09PSBcIm5vZGVzXCIpIHtcbiAgICAgIHN0bXQubm9kZXNbMF0ucmF3cy5iZWZvcmUgPSBzdG10Lm5vZGVzWzBdLnJhd3MuYmVmb3JlIHx8IFwiXFxuXCJcbiAgICB9XG4gIH0pXG59XG5cbmZ1bmN0aW9uIGFwcGx5TWVkaWEoYnVuZGxlKSB7XG4gIGJ1bmRsZS5mb3JFYWNoKHN0bXQgPT4ge1xuICAgIGlmICghc3RtdC5tZWRpYS5sZW5ndGgpIHJldHVyblxuICAgIGlmIChzdG10LnR5cGUgPT09IFwiaW1wb3J0XCIpIHtcbiAgICAgIHN0bXQubm9kZS5wYXJhbXMgPSBgJHtzdG10LmZ1bGxVcml9ICR7c3RtdC5tZWRpYS5qb2luKFwiLCBcIil9YFxuICAgIH0gZWxzZSBpZiAoc3RtdC50eXBlID09PSBcIm1lZGlhXCIpIHN0bXQubm9kZS5wYXJhbXMgPSBzdG10Lm1lZGlhLmpvaW4oXCIsIFwiKVxuICAgIGVsc2Uge1xuICAgICAgY29uc3Qgbm9kZXMgPSBzdG10Lm5vZGVzXG4gICAgICBjb25zdCBwYXJlbnQgPSBub2Rlc1swXS5wYXJlbnRcbiAgICAgIGNvbnN0IG1lZGlhTm9kZSA9IHBvc3Rjc3MuYXRSdWxlKHtcbiAgICAgICAgbmFtZTogXCJtZWRpYVwiLFxuICAgICAgICBwYXJhbXM6IHN0bXQubWVkaWEuam9pbihcIiwgXCIpLFxuICAgICAgICBzb3VyY2U6IHBhcmVudC5zb3VyY2UsXG4gICAgICB9KVxuXG4gICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGVzWzBdLCBtZWRpYU5vZGUpXG5cbiAgICAgIC8vIHJlbW92ZSBub2Rlc1xuICAgICAgbm9kZXMuZm9yRWFjaChub2RlID0+IHtcbiAgICAgICAgbm9kZS5wYXJlbnQgPSB1bmRlZmluZWRcbiAgICAgIH0pXG5cbiAgICAgIC8vIGJldHRlciBvdXRwdXRcbiAgICAgIG5vZGVzWzBdLnJhd3MuYmVmb3JlID0gbm9kZXNbMF0ucmF3cy5iZWZvcmUgfHwgXCJcXG5cIlxuXG4gICAgICAvLyB3cmFwIG5ldyBydWxlcyB3aXRoIG1lZGlhIHF1ZXJ5XG4gICAgICBtZWRpYU5vZGUuYXBwZW5kKG5vZGVzKVxuXG4gICAgICBzdG10LnR5cGUgPSBcIm1lZGlhXCJcbiAgICAgIHN0bXQubm9kZSA9IG1lZGlhTm9kZVxuICAgICAgZGVsZXRlIHN0bXQubm9kZXNcbiAgICB9XG4gIH0pXG59XG5cbmZ1bmN0aW9uIGFwcGx5U3R5bGVzKGJ1bmRsZSwgc3R5bGVzKSB7XG4gIHN0eWxlcy5ub2RlcyA9IFtdXG5cbiAgLy8gU3RyaXAgYWRkaXRpb25hbCBzdGF0ZW1lbnRzLlxuICBidW5kbGUuZm9yRWFjaChzdG10ID0+IHtcbiAgICBpZiAoc3RtdC50eXBlID09PSBcImltcG9ydFwiKSB7XG4gICAgICBzdG10Lm5vZGUucGFyZW50ID0gdW5kZWZpbmVkXG4gICAgICBzdHlsZXMuYXBwZW5kKHN0bXQubm9kZSlcbiAgICB9IGVsc2UgaWYgKHN0bXQudHlwZSA9PT0gXCJtZWRpYVwiKSB7XG4gICAgICBzdG10Lm5vZGUucGFyZW50ID0gdW5kZWZpbmVkXG4gICAgICBzdHlsZXMuYXBwZW5kKHN0bXQubm9kZSlcbiAgICB9IGVsc2UgaWYgKHN0bXQudHlwZSA9PT0gXCJub2Rlc1wiKSB7XG4gICAgICBzdG10Lm5vZGVzLmZvckVhY2gobm9kZSA9PiB7XG4gICAgICAgIG5vZGUucGFyZW50ID0gdW5kZWZpbmVkXG4gICAgICAgIHN0eWxlcy5hcHBlbmQobm9kZSlcbiAgICAgIH0pXG4gICAgfVxuICB9KVxufVxuXG5mdW5jdGlvbiBwYXJzZVN0eWxlcyhyZXN1bHQsIHN0eWxlcywgb3B0aW9ucywgc3RhdGUsIG1lZGlhKSB7XG4gIGNvbnN0IHN0YXRlbWVudHMgPSBwYXJzZVN0YXRlbWVudHMocmVzdWx0LCBzdHlsZXMpXG5cbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShzdGF0ZW1lbnRzKVxuICAgIC50aGVuKHN0bXRzID0+IHtcbiAgICAgIC8vIHByb2Nlc3MgZWFjaCBzdGF0ZW1lbnQgaW4gc2VyaWVzXG4gICAgICByZXR1cm4gc3RtdHMucmVkdWNlKChwcm9taXNlLCBzdG10KSA9PiB7XG4gICAgICAgIHJldHVybiBwcm9taXNlLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIHN0bXQubWVkaWEgPSBqb2luTWVkaWEobWVkaWEsIHN0bXQubWVkaWEgfHwgW10pXG5cbiAgICAgICAgICAvLyBza2lwIHByb3RvY29sIGJhc2UgdXJpIChwcm90b2NvbDovL3VybCkgb3IgcHJvdG9jb2wtcmVsYXRpdmVcbiAgICAgICAgICBpZiAoc3RtdC50eXBlICE9PSBcImltcG9ydFwiIHx8IC9eKD86W2Etel0rOik/XFwvXFwvL2kudGVzdChzdG10LnVyaSkpIHtcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChvcHRpb25zLmZpbHRlciAmJiAhb3B0aW9ucy5maWx0ZXIoc3RtdC51cmkpKSB7XG4gICAgICAgICAgICAvLyByZWplY3RlZCBieSBmaWx0ZXJcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiByZXNvbHZlSW1wb3J0SWQocmVzdWx0LCBzdG10LCBvcHRpb25zLCBzdGF0ZSlcbiAgICAgICAgfSlcbiAgICAgIH0sIFByb21pc2UucmVzb2x2ZSgpKVxuICAgIH0pXG4gICAgLnRoZW4oKCkgPT4ge1xuICAgICAgY29uc3QgaW1wb3J0cyA9IFtdXG4gICAgICBjb25zdCBidW5kbGUgPSBbXVxuXG4gICAgICAvLyBzcXVhc2ggc3RhdGVtZW50cyBhbmQgdGhlaXIgY2hpbGRyZW5cbiAgICAgIHN0YXRlbWVudHMuZm9yRWFjaChzdG10ID0+IHtcbiAgICAgICAgaWYgKHN0bXQudHlwZSA9PT0gXCJpbXBvcnRcIikge1xuICAgICAgICAgIGlmIChzdG10LmNoaWxkcmVuKSB7XG4gICAgICAgICAgICBzdG10LmNoaWxkcmVuLmZvckVhY2goKGNoaWxkLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgICBpZiAoY2hpbGQudHlwZSA9PT0gXCJpbXBvcnRcIikgaW1wb3J0cy5wdXNoKGNoaWxkKVxuICAgICAgICAgICAgICBlbHNlIGJ1bmRsZS5wdXNoKGNoaWxkKVxuICAgICAgICAgICAgICAvLyBGb3IgYmV0dGVyIG91dHB1dFxuICAgICAgICAgICAgICBpZiAoaW5kZXggPT09IDApIGNoaWxkLnBhcmVudCA9IHN0bXRcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfSBlbHNlIGltcG9ydHMucHVzaChzdG10KVxuICAgICAgICB9IGVsc2UgaWYgKHN0bXQudHlwZSA9PT0gXCJtZWRpYVwiIHx8IHN0bXQudHlwZSA9PT0gXCJub2Rlc1wiKSB7XG4gICAgICAgICAgYnVuZGxlLnB1c2goc3RtdClcbiAgICAgICAgfVxuICAgICAgfSlcblxuICAgICAgcmV0dXJuIGltcG9ydHMuY29uY2F0KGJ1bmRsZSlcbiAgICB9KVxufVxuXG5mdW5jdGlvbiByZXNvbHZlSW1wb3J0SWQocmVzdWx0LCBzdG10LCBvcHRpb25zLCBzdGF0ZSkge1xuICBjb25zdCBhdFJ1bGUgPSBzdG10Lm5vZGVcbiAgbGV0IHNvdXJjZUZpbGVcbiAgaWYgKGF0UnVsZS5zb3VyY2UgJiYgYXRSdWxlLnNvdXJjZS5pbnB1dCAmJiBhdFJ1bGUuc291cmNlLmlucHV0LmZpbGUpIHtcbiAgICBzb3VyY2VGaWxlID0gYXRSdWxlLnNvdXJjZS5pbnB1dC5maWxlXG4gIH1cbiAgY29uc3QgYmFzZSA9IHNvdXJjZUZpbGVcbiAgICA/IHBhdGguZGlybmFtZShhdFJ1bGUuc291cmNlLmlucHV0LmZpbGUpXG4gICAgOiBvcHRpb25zLnJvb3RcblxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG9wdGlvbnMucmVzb2x2ZShzdG10LnVyaSwgYmFzZSwgb3B0aW9ucykpXG4gICAgLnRoZW4ocGF0aHMgPT4ge1xuICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHBhdGhzKSkgcGF0aHMgPSBbcGF0aHNdXG4gICAgICAvLyBFbnN1cmUgdGhhdCBlYWNoIHBhdGggaXMgYWJzb2x1dGU6XG4gICAgICByZXR1cm4gUHJvbWlzZS5hbGwoXG4gICAgICAgIHBhdGhzLm1hcChmaWxlID0+IHtcbiAgICAgICAgICByZXR1cm4gIXBhdGguaXNBYnNvbHV0ZShmaWxlKSA/IHJlc29sdmVJZChmaWxlLCBiYXNlLCBvcHRpb25zKSA6IGZpbGVcbiAgICAgICAgfSlcbiAgICAgIClcbiAgICB9KVxuICAgIC50aGVuKHJlc29sdmVkID0+IHtcbiAgICAgIC8vIEFkZCBkZXBlbmRlbmN5IG1lc3NhZ2VzOlxuICAgICAgcmVzb2x2ZWQuZm9yRWFjaChmaWxlID0+IHtcbiAgICAgICAgcmVzdWx0Lm1lc3NhZ2VzLnB1c2goe1xuICAgICAgICAgIHR5cGU6IFwiZGVwZW5kZW5jeVwiLFxuICAgICAgICAgIGZpbGU6IGZpbGUsXG4gICAgICAgICAgcGFyZW50OiBzb3VyY2VGaWxlLFxuICAgICAgICB9KVxuICAgICAgfSlcblxuICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFxuICAgICAgICByZXNvbHZlZC5tYXAoZmlsZSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGxvYWRJbXBvcnRDb250ZW50KHJlc3VsdCwgc3RtdCwgZmlsZSwgb3B0aW9ucywgc3RhdGUpXG4gICAgICAgIH0pXG4gICAgICApXG4gICAgfSlcbiAgICAudGhlbihyZXN1bHQgPT4ge1xuICAgICAgLy8gTWVyZ2UgbG9hZGVkIHN0YXRlbWVudHNcbiAgICAgIHN0bXQuY2hpbGRyZW4gPSByZXN1bHQucmVkdWNlKChyZXN1bHQsIHN0YXRlbWVudHMpID0+IHtcbiAgICAgICAgcmV0dXJuIHN0YXRlbWVudHMgPyByZXN1bHQuY29uY2F0KHN0YXRlbWVudHMpIDogcmVzdWx0XG4gICAgICB9LCBbXSlcbiAgICB9KVxufVxuXG5mdW5jdGlvbiBsb2FkSW1wb3J0Q29udGVudChyZXN1bHQsIHN0bXQsIGZpbGVuYW1lLCBvcHRpb25zLCBzdGF0ZSkge1xuICBjb25zdCBhdFJ1bGUgPSBzdG10Lm5vZGVcbiAgY29uc3QgbWVkaWEgPSBzdG10Lm1lZGlhXG4gIGlmIChvcHRpb25zLnNraXBEdXBsaWNhdGVzKSB7XG4gICAgLy8gc2tpcCBmaWxlcyBhbHJlYWR5IGltcG9ydGVkIGF0IHRoZSBzYW1lIHNjb3BlXG4gICAgaWYgKHN0YXRlLmltcG9ydGVkRmlsZXNbZmlsZW5hbWVdICYmIHN0YXRlLmltcG9ydGVkRmlsZXNbZmlsZW5hbWVdW21lZGlhXSkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgLy8gc2F2ZSBpbXBvcnRlZCBmaWxlcyB0byBza2lwIHRoZW0gbmV4dCB0aW1lXG4gICAgaWYgKCFzdGF0ZS5pbXBvcnRlZEZpbGVzW2ZpbGVuYW1lXSkgc3RhdGUuaW1wb3J0ZWRGaWxlc1tmaWxlbmFtZV0gPSB7fVxuICAgIHN0YXRlLmltcG9ydGVkRmlsZXNbZmlsZW5hbWVdW21lZGlhXSA9IHRydWVcbiAgfVxuXG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUob3B0aW9ucy5sb2FkKGZpbGVuYW1lLCBvcHRpb25zKSkudGhlbihjb250ZW50ID0+IHtcbiAgICBpZiAoY29udGVudC50cmltKCkgPT09IFwiXCIpIHtcbiAgICAgIHJlc3VsdC53YXJuKGAke2ZpbGVuYW1lfSBpcyBlbXB0eWAsIHsgbm9kZTogYXRSdWxlIH0pXG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICAvLyBza2lwIHByZXZpb3VzIGltcG9ydGVkIGZpbGVzIG5vdCBjb250YWluaW5nIEBpbXBvcnQgcnVsZXNcbiAgICBpZiAoc3RhdGUuaGFzaEZpbGVzW2NvbnRlbnRdICYmIHN0YXRlLmhhc2hGaWxlc1tjb250ZW50XVttZWRpYV0pIHJldHVyblxuXG4gICAgcmV0dXJuIHByb2Nlc3NDb250ZW50KHJlc3VsdCwgY29udGVudCwgZmlsZW5hbWUsIG9wdGlvbnMpLnRoZW4oXG4gICAgICBpbXBvcnRlZFJlc3VsdCA9PiB7XG4gICAgICAgIGNvbnN0IHN0eWxlcyA9IGltcG9ydGVkUmVzdWx0LnJvb3RcbiAgICAgICAgcmVzdWx0Lm1lc3NhZ2VzID0gcmVzdWx0Lm1lc3NhZ2VzLmNvbmNhdChpbXBvcnRlZFJlc3VsdC5tZXNzYWdlcylcblxuICAgICAgICBpZiAob3B0aW9ucy5za2lwRHVwbGljYXRlcykge1xuICAgICAgICAgIGNvbnN0IGhhc0ltcG9ydCA9IHN0eWxlcy5zb21lKGNoaWxkID0+IHtcbiAgICAgICAgICAgIHJldHVybiBjaGlsZC50eXBlID09PSBcImF0cnVsZVwiICYmIGNoaWxkLm5hbWUgPT09IFwiaW1wb3J0XCJcbiAgICAgICAgICB9KVxuICAgICAgICAgIGlmICghaGFzSW1wb3J0KSB7XG4gICAgICAgICAgICAvLyBzYXZlIGhhc2ggZmlsZXMgdG8gc2tpcCB0aGVtIG5leHQgdGltZVxuICAgICAgICAgICAgaWYgKCFzdGF0ZS5oYXNoRmlsZXNbY29udGVudF0pIHN0YXRlLmhhc2hGaWxlc1tjb250ZW50XSA9IHt9XG4gICAgICAgICAgICBzdGF0ZS5oYXNoRmlsZXNbY29udGVudF1bbWVkaWFdID0gdHJ1ZVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHJlY3Vyc2lvbjogaW1wb3J0IEBpbXBvcnQgZnJvbSBpbXBvcnRlZCBmaWxlXG4gICAgICAgIHJldHVybiBwYXJzZVN0eWxlcyhyZXN1bHQsIHN0eWxlcywgb3B0aW9ucywgc3RhdGUsIG1lZGlhKVxuICAgICAgfVxuICAgIClcbiAgfSlcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBwb3N0Y3NzLnBsdWdpbihcInBvc3Rjc3MtaW1wb3J0XCIsIEF0SW1wb3J0KTsiXX0=