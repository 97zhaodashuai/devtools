'use strict';

var _util = require('./util');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _watch = require('watch');

var _watch2 = _interopRequireDefault(_watch);

var _frameworkFlow = require('./framework-flow');

var _frameworkFlow2 = _interopRequireDefault(_frameworkFlow);

var _index = require('./index');

var _index2 = _interopRequireDefault(_index);

var _log = require('./log');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var _global$SWAN_CLI_ARGV = global.SWAN_CLI_ARGV,
    OUTPUT = _global$SWAN_CLI_ARGV.OUTPUT,
    WORK_PATH = _global$SWAN_CLI_ARGV.WORK_PATH,
    SWAN_CORE_PATH = _global$SWAN_CLI_ARGV.SWAN_CORE_PATH,
    SOURCEMAP = _global$SWAN_CLI_ARGV.SOURCEMAP,
    UGLIFY = _global$SWAN_CLI_ARGV.UGLIFY,
    COMPILED_CORE_PATH = _global$SWAN_CLI_ARGV.COMPILED_CORE_PATH,
    COMPILE_SUBPACKAGE = _global$SWAN_CLI_ARGV.COMPILE_SUBPACKAGE,
    USE_OLD_HTML = _global$SWAN_CLI_ARGV.USE_OLD_HTML,
    SWAN_CLI_PROCESS = _global$SWAN_CLI_ARGV.SWAN_CLI_PROCESS,
    SAN_DEV_HOOK = _global$SWAN_CLI_ARGV.SAN_DEV_HOOK,
    COMMAND = _global$SWAN_CLI_ARGV.COMMAND; /**
                                              * @file 根据开发者app.json配置生成slave的html
                                              * @author zhuxin04
                                              */

OUTPUT = OUTPUT || (0, _util.pathResolve)(__dirname, './tests/output');
SWAN_CORE_PATH = SWAN_CORE_PATH || '';
var BASE_PATH = (0, _util.formatPath)((0, _util.pathJoin)(__dirname, '../'));
global.SWAN_CLI_ARGV.BASE_PATH = BASE_PATH;
WORK_PATH = (0, _util.formatPath)((0, _util.isAbsolutePath)(WORK_PATH) ? WORK_PATH : (0, _util.pathJoin)(SWAN_CLI_PROCESS.cwd(), WORK_PATH));
OUTPUT = (0, _util.formatPath)((0, _util.isAbsolutePath)(OUTPUT) ? OUTPUT : (0, _util.pathJoin)(SWAN_CLI_PROCESS.cwd(), OUTPUT));
SWAN_CORE_PATH = (0, _util.formatPath)((0, _util.isAbsolutePath)(SWAN_CORE_PATH) ? SWAN_CORE_PATH : (0, _util.pathJoin)(BASE_PATH, '/node_modules/@super-fe/swan-core'));
var defaultOptions = {
    sourcemaps: SOURCEMAP || 'inline',
    uglify: UGLIFY || false,
    subPackage: COMPILE_SUBPACKAGE,
    useOldPackHtml: USE_OLD_HTML,
    sanDevHook: SAN_DEV_HOOK,
    log: {
        log: function log(text) {
            console.log(text);
        },
        warn: function warn(text) {
            console.warn(text);
        }
    }
};
var appConfig = (0, _util.getAppConfig)(WORK_PATH);
var errorFn = function errorFn(e) {
    console.log(e);
};
var ignoreDir = new RegExp('' + OUTPUT);
var watchOptions = {
    ignoreDotFiles: true,
    ignoreDirectoryPattern: ignoreDir,
    interval: 0
};

function userCodeRemoteDeploy() {
    var deployPath = _fs2.default.readFileSync('mydev', 'utf-8');
    deployPath = /\s*deployPath\s*=(.*)/g.exec(deployPath)[1];
    var defaultDeployPath = deployPath.replace(/(^\s*)|(\s*$)/g, '') + '/';
    (0, _index2.default)(appConfig, BASE_PATH, WORK_PATH, defaultDeployPath, SWAN_CORE_PATH, false, defaultOptions, errorFn);
}

function removeOldOutput(path) {
    var files = [];
    if (_fs2.default.existsSync(path)) {
        files = _fs2.default.readdirSync(path);
        files.forEach(function (file, index) {
            var curPath = (0, _util.pathJoin)(path, file);
            if (_fs2.default.statSync(curPath).isDirectory()) {
                removeOldOutput(curPath);
            } else {
                _fs2.default.unlinkSync(curPath);
            }
        });
        _fs2.default.rmdirSync(path);
    }
}

function resetLogEvent() {
    Object.keys(_log.finishObj).forEach(function (key) {
        _log.finishObj[key] = 0;
    });
    Object.keys(_log.recordObj['developer']).forEach(function (key) {
        _log.recordObj['developer'][key] = 0;
    });
    Object.keys(_log.processionObj).forEach(function (key) {
        _log.processionObj[key] = false;
    });
}

if (!COMMAND.length) {
    removeOldOutput(OUTPUT);
    var options = Object.assign({}, defaultOptions, {
        htmlReplaceVariables: {}
    });
    if (COMPILED_CORE_PATH) {
        options.htmlReplaceVariables['{#swanCorePath#}'] = COMPILED_CORE_PATH;
    }
    if (SAN_DEV_HOOK) {
        Object.assign(options.htmlReplaceVariables, {
            '<!-- swan master hook -->': '<script type="text/javascript" src="../swan-devhook/master.js"></script>',
            '<!-- swan slave hook -->': '<script type="text/javascript" src="../swan-devhook/slave.js"></script>'
        });
    }
    (0, _index2.default)(appConfig, BASE_PATH, WORK_PATH, OUTPUT, SWAN_CORE_PATH, true, options, errorFn);
} else if (COMMAND.indexOf('watch') !== -1) {
    removeOldOutput(OUTPUT);
    var _ignoreDir = new RegExp('' + OUTPUT);
    _watch2.default.watchTree(WORK_PATH, watchOptions, function (modFile, curr, prev) {
        resetLogEvent();
        (0, _index2.default)(appConfig, BASE_PATH, WORK_PATH, OUTPUT, SWAN_CORE_PATH, true, defaultOptions, errorFn);
    });
} else if (COMMAND.indexOf('watchremote') !== -1) {
    var _ignoreDir2 = new RegExp('' + OUTPUT);
    _watch2.default.watchTree(WORK_PATH, watchOptions, function (modFile, curr, prev) {
        userCodeRemoteDeploy();
    });
} else if (COMMAND.indexOf('userCodeRemoteDeploy') !== -1) {
    userCodeRemoteDeploy();
} else if (COMMAND.indexOf('compileUserCode') !== -1) {
    (0, _index2.default)(appConfig, BASE_PATH, WORK_PATH, OUTPUT, SWAN_CORE_PATH, false, defaultOptions, errorFn);
} else if (COMMAND.indexOf('oldPack') !== -1) {
    var corePath = _fs2.default.readFileSync('mydev', 'utf-8');
    corePath = /\s*corePath\s*=(.*)/g.exec(corePath)[1];
    var swanCorePath = corePath.replace(/(^\s*)|(\s*$)/g, '') + '/';
    var _options = Object.assign({}, defaultOptions, {
        htmlReplaceVariables: {
            '{#swanCorePath#}': swanCorePath
        }
    });
    (0, _index2.default)(appConfig, BASE_PATH, WORK_PATH, OUTPUT, SWAN_CORE_PATH, true, _options, errorFn);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9ydW4uanMiXSwibmFtZXMiOlsiZ2xvYmFsIiwiU1dBTl9DTElfQVJHViIsIk9VVFBVVCIsIldPUktfUEFUSCIsIlNXQU5fQ09SRV9QQVRIIiwiU09VUkNFTUFQIiwiVUdMSUZZIiwiQ09NUElMRURfQ09SRV9QQVRIIiwiQ09NUElMRV9TVUJQQUNLQUdFIiwiVVNFX09MRF9IVE1MIiwiU1dBTl9DTElfUFJPQ0VTUyIsIlNBTl9ERVZfSE9PSyIsIkNPTU1BTkQiLCJfX2Rpcm5hbWUiLCJCQVNFX1BBVEgiLCJjd2QiLCJkZWZhdWx0T3B0aW9ucyIsInNvdXJjZW1hcHMiLCJ1Z2xpZnkiLCJzdWJQYWNrYWdlIiwidXNlT2xkUGFja0h0bWwiLCJzYW5EZXZIb29rIiwibG9nIiwidGV4dCIsImNvbnNvbGUiLCJ3YXJuIiwiYXBwQ29uZmlnIiwiZXJyb3JGbiIsImUiLCJpZ25vcmVEaXIiLCJSZWdFeHAiLCJ3YXRjaE9wdGlvbnMiLCJpZ25vcmVEb3RGaWxlcyIsImlnbm9yZURpcmVjdG9yeVBhdHRlcm4iLCJpbnRlcnZhbCIsInVzZXJDb2RlUmVtb3RlRGVwbG95IiwiZGVwbG95UGF0aCIsImZzIiwicmVhZEZpbGVTeW5jIiwiZXhlYyIsImRlZmF1bHREZXBsb3lQYXRoIiwicmVwbGFjZSIsInJlbW92ZU9sZE91dHB1dCIsInBhdGgiLCJmaWxlcyIsImV4aXN0c1N5bmMiLCJyZWFkZGlyU3luYyIsImZvckVhY2giLCJmaWxlIiwiaW5kZXgiLCJjdXJQYXRoIiwic3RhdFN5bmMiLCJpc0RpcmVjdG9yeSIsInVubGlua1N5bmMiLCJybWRpclN5bmMiLCJyZXNldExvZ0V2ZW50IiwiT2JqZWN0Iiwia2V5cyIsImZpbmlzaE9iaiIsImtleSIsInJlY29yZE9iaiIsInByb2Nlc3Npb25PYmoiLCJsZW5ndGgiLCJvcHRpb25zIiwiYXNzaWduIiwiaHRtbFJlcGxhY2VWYXJpYWJsZXMiLCJpbmRleE9mIiwid2F0Y2giLCJ3YXRjaFRyZWUiLCJtb2RGaWxlIiwiY3VyciIsInByZXYiLCJjb3JlUGF0aCIsInN3YW5Db3JlUGF0aCJdLCJtYXBwaW5ncyI6Ijs7QUFJQTs7QUFPQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7NEJBYUlBLE9BQU9DLGE7SUFYUEMsTSx5QkFBQUEsTTtJQUNBQyxTLHlCQUFBQSxTO0lBQ0FDLGMseUJBQUFBLGM7SUFDQUMsUyx5QkFBQUEsUztJQUNBQyxNLHlCQUFBQSxNO0lBQ0FDLGtCLHlCQUFBQSxrQjtJQUNBQyxrQix5QkFBQUEsa0I7SUFDQUMsWSx5QkFBQUEsWTtJQUNBQyxnQix5QkFBQUEsZ0I7SUFDQUMsWSx5QkFBQUEsWTtJQUNBQyxPLHlCQUFBQSxPLEVBNUJKOzs7OztBQThCQVYsU0FBU0EsVUFBVSx1QkFBWVcsU0FBWixFQUF1QixnQkFBdkIsQ0FBbkI7QUFDQVQsaUJBQWlCQSxrQkFBa0IsRUFBbkM7QUFDQSxJQUFNVSxZQUFZLHNCQUFXLG9CQUFTRCxTQUFULEVBQW9CLEtBQXBCLENBQVgsQ0FBbEI7QUFDQWIsT0FBT0MsYUFBUCxDQUFxQmEsU0FBckIsR0FBaUNBLFNBQWpDO0FBQ0FYLFlBQVksc0JBQVcsMEJBQWVBLFNBQWYsSUFBNEJBLFNBQTVCLEdBQXdDLG9CQUFTTyxpQkFBaUJLLEdBQWpCLEVBQVQsRUFBaUNaLFNBQWpDLENBQW5ELENBQVo7QUFDQUQsU0FBUyxzQkFBVywwQkFBZUEsTUFBZixJQUF5QkEsTUFBekIsR0FBa0Msb0JBQVNRLGlCQUFpQkssR0FBakIsRUFBVCxFQUFpQ2IsTUFBakMsQ0FBN0MsQ0FBVDtBQUNBRSxpQkFBaUIsc0JBQVcsMEJBQWVBLGNBQWYsSUFBaUNBLGNBQWpDLEdBQWtELG9CQUFTVSxTQUFULEVBQW9CLG1DQUFwQixDQUE3RCxDQUFqQjtBQUNBLElBQU1FLGlCQUFpQjtBQUNuQkMsZ0JBQVlaLGFBQWEsUUFETjtBQUVuQmEsWUFBUVosVUFBVSxLQUZDO0FBR25CYSxnQkFBWVgsa0JBSE87QUFJbkJZLG9CQUFnQlgsWUFKRztBQUtuQlksZ0JBQVlWLFlBTE87QUFNbkJXLFNBQUs7QUFDREEsV0FEQyxlQUNHQyxJQURILEVBQ1M7QUFDTkMsb0JBQVFGLEdBQVIsQ0FBWUMsSUFBWjtBQUNILFNBSEE7QUFJREUsWUFKQyxnQkFJSUYsSUFKSixFQUlVO0FBQ1BDLG9CQUFRQyxJQUFSLENBQWFGLElBQWI7QUFDSDtBQU5BO0FBTmMsQ0FBdkI7QUFlQSxJQUFNRyxZQUFZLHdCQUFhdkIsU0FBYixDQUFsQjtBQUNBLElBQU13QixVQUFVLFNBQVNBLE9BQVQsQ0FBaUJDLENBQWpCLEVBQW9CO0FBQ2hDSixZQUFRRixHQUFSLENBQVlNLENBQVo7QUFDSCxDQUZEO0FBR0EsSUFBTUMsWUFBWSxJQUFJQyxNQUFKLE1BQWM1QixNQUFkLENBQWxCO0FBQ0EsSUFBTTZCLGVBQWU7QUFDakJDLG9CQUFnQixJQURDO0FBRWpCQyw0QkFBd0JKLFNBRlA7QUFHakJLLGNBQVU7QUFITyxDQUFyQjs7QUFNQSxTQUFTQyxvQkFBVCxHQUFnQztBQUM1QixRQUFJQyxhQUFhQyxhQUFHQyxZQUFILENBQWdCLE9BQWhCLEVBQXlCLE9BQXpCLENBQWpCO0FBQ0FGLGlCQUFhLHlCQUF5QkcsSUFBekIsQ0FBOEJILFVBQTlCLEVBQTBDLENBQTFDLENBQWI7QUFDQSxRQUFNSSxvQkFBb0JKLFdBQVdLLE9BQVgsQ0FBbUIsZ0JBQW5CLEVBQXFDLEVBQXJDLElBQTJDLEdBQXJFO0FBQ0EseUJBQWlCZixTQUFqQixFQUE0QlosU0FBNUIsRUFBdUNYLFNBQXZDLEVBQWtEcUMsaUJBQWxELEVBQXFFcEMsY0FBckUsRUFBcUYsS0FBckYsRUFBNEZZLGNBQTVGLEVBQTRHVyxPQUE1RztBQUNIOztBQUVELFNBQVNlLGVBQVQsQ0FBeUJDLElBQXpCLEVBQStCO0FBQzNCLFFBQUlDLFFBQVEsRUFBWjtBQUNBLFFBQUdQLGFBQUdRLFVBQUgsQ0FBY0YsSUFBZCxDQUFILEVBQXdCO0FBQ3BCQyxnQkFBUVAsYUFBR1MsV0FBSCxDQUFlSCxJQUFmLENBQVI7QUFDQUMsY0FBTUcsT0FBTixDQUFjLFVBQVNDLElBQVQsRUFBZUMsS0FBZixFQUFzQjtBQUNoQyxnQkFBSUMsVUFBVSxvQkFBU1AsSUFBVCxFQUFlSyxJQUFmLENBQWQ7QUFDQSxnQkFBR1gsYUFBR2MsUUFBSCxDQUFZRCxPQUFaLEVBQXFCRSxXQUFyQixFQUFILEVBQXVDO0FBQ25DVixnQ0FBZ0JRLE9BQWhCO0FBQ0gsYUFGRCxNQUVPO0FBQ0hiLDZCQUFHZ0IsVUFBSCxDQUFjSCxPQUFkO0FBQ0g7QUFDSixTQVBEO0FBUUFiLHFCQUFHaUIsU0FBSCxDQUFhWCxJQUFiO0FBQ0g7QUFDSjs7QUFFRCxTQUFTWSxhQUFULEdBQXlCO0FBQ3JCQyxXQUFPQyxJQUFQLENBQVlDLGNBQVosRUFBdUJYLE9BQXZCLENBQStCLGVBQU87QUFDbENXLHVCQUFVQyxHQUFWLElBQWlCLENBQWpCO0FBQ0gsS0FGRDtBQUdBSCxXQUFPQyxJQUFQLENBQVlHLGVBQVUsV0FBVixDQUFaLEVBQW9DYixPQUFwQyxDQUE0QyxlQUFPO0FBQy9DYSx1QkFBVSxXQUFWLEVBQXVCRCxHQUF2QixJQUE4QixDQUE5QjtBQUNILEtBRkQ7QUFHQUgsV0FBT0MsSUFBUCxDQUFZSSxrQkFBWixFQUEyQmQsT0FBM0IsQ0FBbUMsZUFBTztBQUN0Q2MsMkJBQWNGLEdBQWQsSUFBcUIsS0FBckI7QUFDSCxLQUZEO0FBR0g7O0FBRUQsSUFBSSxDQUFDL0MsUUFBUWtELE1BQWIsRUFBcUI7QUFDakJwQixvQkFBZ0J4QyxNQUFoQjtBQUNBLFFBQUk2RCxVQUFVUCxPQUFPUSxNQUFQLENBQWMsRUFBZCxFQUFrQmhELGNBQWxCLEVBQWtDO0FBQzVDaUQsOEJBQXNCO0FBRHNCLEtBQWxDLENBQWQ7QUFHQSxRQUFJMUQsa0JBQUosRUFBd0I7QUFDcEJ3RCxnQkFBUUUsb0JBQVIsQ0FBNkIsa0JBQTdCLElBQW1EMUQsa0JBQW5EO0FBQ0g7QUFDRCxRQUFJSSxZQUFKLEVBQWtCO0FBQ2Q2QyxlQUFPUSxNQUFQLENBQWNELFFBQVFFLG9CQUF0QixFQUE0QztBQUN4Qyx5Q0FBNkIsMEVBRFc7QUFFeEMsd0NBQTRCO0FBRlksU0FBNUM7QUFJSDtBQUNELHlCQUFpQnZDLFNBQWpCLEVBQTRCWixTQUE1QixFQUF1Q1gsU0FBdkMsRUFBa0RELE1BQWxELEVBQTBERSxjQUExRCxFQUEwRSxJQUExRSxFQUFnRjJELE9BQWhGLEVBQXlGcEMsT0FBekY7QUFDSCxDQWZELE1BZU8sSUFBSWYsUUFBUXNELE9BQVIsQ0FBZ0IsT0FBaEIsTUFBNkIsQ0FBQyxDQUFsQyxFQUFxQztBQUN4Q3hCLG9CQUFnQnhDLE1BQWhCO0FBQ0EsUUFBSTJCLGFBQVksSUFBSUMsTUFBSixNQUFjNUIsTUFBZCxDQUFoQjtBQUNBaUUsb0JBQU1DLFNBQU4sQ0FBZ0JqRSxTQUFoQixFQUEyQjRCLFlBQTNCLEVBQXlDLFVBQVVzQyxPQUFWLEVBQW1CQyxJQUFuQixFQUF5QkMsSUFBekIsRUFBK0I7QUFDcEVoQjtBQUNBLDZCQUFpQjdCLFNBQWpCLEVBQTRCWixTQUE1QixFQUF1Q1gsU0FBdkMsRUFBa0RELE1BQWxELEVBQTBERSxjQUExRCxFQUEwRSxJQUExRSxFQUFnRlksY0FBaEYsRUFBZ0dXLE9BQWhHO0FBQ0gsS0FIRDtBQUlILENBUE0sTUFPQSxJQUFJZixRQUFRc0QsT0FBUixDQUFnQixhQUFoQixNQUFtQyxDQUFDLENBQXhDLEVBQTJDO0FBQzlDLFFBQUlyQyxjQUFZLElBQUlDLE1BQUosTUFBYzVCLE1BQWQsQ0FBaEI7QUFDQWlFLG9CQUFNQyxTQUFOLENBQWdCakUsU0FBaEIsRUFBMkI0QixZQUEzQixFQUF5QyxVQUFVc0MsT0FBVixFQUFtQkMsSUFBbkIsRUFBeUJDLElBQXpCLEVBQStCO0FBQ3BFcEM7QUFDSCxLQUZEO0FBR0gsQ0FMTSxNQUtBLElBQUl2QixRQUFRc0QsT0FBUixDQUFnQixzQkFBaEIsTUFBNEMsQ0FBQyxDQUFqRCxFQUFvRDtBQUN2RC9CO0FBQ0gsQ0FGTSxNQUVBLElBQUl2QixRQUFRc0QsT0FBUixDQUFnQixpQkFBaEIsTUFBdUMsQ0FBQyxDQUE1QyxFQUErQztBQUNsRCx5QkFBaUJ4QyxTQUFqQixFQUE0QlosU0FBNUIsRUFBdUNYLFNBQXZDLEVBQWtERCxNQUFsRCxFQUEwREUsY0FBMUQsRUFBMEUsS0FBMUUsRUFBaUZZLGNBQWpGLEVBQWlHVyxPQUFqRztBQUNILENBRk0sTUFFQSxJQUFJZixRQUFRc0QsT0FBUixDQUFnQixTQUFoQixNQUErQixDQUFDLENBQXBDLEVBQXVDO0FBQzFDLFFBQUlNLFdBQVduQyxhQUFHQyxZQUFILENBQWdCLE9BQWhCLEVBQXlCLE9BQXpCLENBQWY7QUFDQWtDLGVBQVcsdUJBQXVCakMsSUFBdkIsQ0FBNEJpQyxRQUE1QixFQUFzQyxDQUF0QyxDQUFYO0FBQ0EsUUFBTUMsZUFBZUQsU0FBUy9CLE9BQVQsQ0FBaUIsZ0JBQWpCLEVBQW1DLEVBQW5DLElBQXlDLEdBQTlEO0FBQ0EsUUFBTXNCLFdBQVVQLE9BQU9RLE1BQVAsQ0FBYyxFQUFkLEVBQWtCaEQsY0FBbEIsRUFBa0M7QUFDOUNpRCw4QkFBc0I7QUFDbEIsZ0NBQW9CUTtBQURGO0FBRHdCLEtBQWxDLENBQWhCO0FBS0EseUJBQWlCL0MsU0FBakIsRUFBNEJaLFNBQTVCLEVBQXVDWCxTQUF2QyxFQUFrREQsTUFBbEQsRUFBMERFLGNBQTFELEVBQTBFLElBQTFFLEVBQWdGMkQsUUFBaEYsRUFBeUZwQyxPQUF6RjtBQUNIIiwiZmlsZSI6InJ1bi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGZpbGUg5qC55o2u5byA5Y+R6ICFYXBwLmpzb27phY3nva7nlJ/miJBzbGF2ZeeahGh0bWxcbiAqIEBhdXRob3Igemh1eGluMDRcbiAqL1xuaW1wb3J0IHtcbiAgICBpc0Fic29sdXRlUGF0aCxcbiAgICBwYXRoSm9pbixcbiAgICBwYXRoUmVzb2x2ZSxcbiAgICBnZXRBcHBDb25maWcsXG4gICAgZm9ybWF0UGF0aFxufSBmcm9tICcuL3V0aWwnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHdhdGNoIGZyb20gJ3dhdGNoJztcbmltcG9ydCBmcmFtZXdvcmtGbG93IGZyb20gJy4vZnJhbWV3b3JrLWZsb3cnO1xuaW1wb3J0IG1lcmdlQWxsZmlsZUZsb3cgZnJvbSAnLi9pbmRleCc7XG5pbXBvcnQge2ZpbmlzaE9iaiwgcmVjb3JkT2JqLCBwcm9jZXNzaW9uT2JqfSBmcm9tICcuL2xvZyc7XG5sZXQge1xuICAgIE9VVFBVVCxcbiAgICBXT1JLX1BBVEgsXG4gICAgU1dBTl9DT1JFX1BBVEgsXG4gICAgU09VUkNFTUFQLFxuICAgIFVHTElGWSxcbiAgICBDT01QSUxFRF9DT1JFX1BBVEgsXG4gICAgQ09NUElMRV9TVUJQQUNLQUdFLFxuICAgIFVTRV9PTERfSFRNTCxcbiAgICBTV0FOX0NMSV9QUk9DRVNTLFxuICAgIFNBTl9ERVZfSE9PSyxcbiAgICBDT01NQU5EXG59ID0gZ2xvYmFsLlNXQU5fQ0xJX0FSR1Y7XG5PVVRQVVQgPSBPVVRQVVQgfHwgcGF0aFJlc29sdmUoX19kaXJuYW1lLCAnLi90ZXN0cy9vdXRwdXQnKTtcblNXQU5fQ09SRV9QQVRIID0gU1dBTl9DT1JFX1BBVEggfHwgJyc7XG5jb25zdCBCQVNFX1BBVEggPSBmb3JtYXRQYXRoKHBhdGhKb2luKF9fZGlybmFtZSwgJy4uLycpKTtcbmdsb2JhbC5TV0FOX0NMSV9BUkdWLkJBU0VfUEFUSCA9IEJBU0VfUEFUSDtcbldPUktfUEFUSCA9IGZvcm1hdFBhdGgoaXNBYnNvbHV0ZVBhdGgoV09SS19QQVRIKSA/IFdPUktfUEFUSCA6IHBhdGhKb2luKFNXQU5fQ0xJX1BST0NFU1MuY3dkKCksIFdPUktfUEFUSCkpO1xuT1VUUFVUID0gZm9ybWF0UGF0aChpc0Fic29sdXRlUGF0aChPVVRQVVQpID8gT1VUUFVUIDogcGF0aEpvaW4oU1dBTl9DTElfUFJPQ0VTUy5jd2QoKSwgT1VUUFVUKSk7XG5TV0FOX0NPUkVfUEFUSCA9IGZvcm1hdFBhdGgoaXNBYnNvbHV0ZVBhdGgoU1dBTl9DT1JFX1BBVEgpID8gU1dBTl9DT1JFX1BBVEggOiBwYXRoSm9pbihCQVNFX1BBVEgsICcvbm9kZV9tb2R1bGVzL0BzdXBlci1mZS9zd2FuLWNvcmUnKSk7XG5jb25zdCBkZWZhdWx0T3B0aW9ucyA9IHtcbiAgICBzb3VyY2VtYXBzOiBTT1VSQ0VNQVAgfHwgJ2lubGluZScsXG4gICAgdWdsaWZ5OiBVR0xJRlkgfHwgZmFsc2UsXG4gICAgc3ViUGFja2FnZTogQ09NUElMRV9TVUJQQUNLQUdFLFxuICAgIHVzZU9sZFBhY2tIdG1sOiBVU0VfT0xEX0hUTUwsXG4gICAgc2FuRGV2SG9vazogU0FOX0RFVl9IT09LLFxuICAgIGxvZzoge1xuICAgICAgICBsb2codGV4dCkge1xuICAgICAgICAgICAgY29uc29sZS5sb2codGV4dCk7XG4gICAgICAgIH0sXG4gICAgICAgIHdhcm4odGV4dCkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKHRleHQpO1xuICAgICAgICB9XG4gICAgfVxufTtcbmNvbnN0IGFwcENvbmZpZyA9IGdldEFwcENvbmZpZyhXT1JLX1BBVEgpO1xuY29uc3QgZXJyb3JGbiA9IGZ1bmN0aW9uIGVycm9yRm4oZSkge1xuICAgIGNvbnNvbGUubG9nKGUpXG59O1xuY29uc3QgaWdub3JlRGlyID0gbmV3IFJlZ0V4cChgJHtPVVRQVVR9YCk7XG5jb25zdCB3YXRjaE9wdGlvbnMgPSB7XG4gICAgaWdub3JlRG90RmlsZXM6IHRydWUsXG4gICAgaWdub3JlRGlyZWN0b3J5UGF0dGVybjogaWdub3JlRGlyLFxuICAgIGludGVydmFsOiAwXG59O1xuXG5mdW5jdGlvbiB1c2VyQ29kZVJlbW90ZURlcGxveSgpIHtcbiAgICBsZXQgZGVwbG95UGF0aCA9IGZzLnJlYWRGaWxlU3luYygnbXlkZXYnLCAndXRmLTgnKTtcbiAgICBkZXBsb3lQYXRoID0gL1xccypkZXBsb3lQYXRoXFxzKj0oLiopL2cuZXhlYyhkZXBsb3lQYXRoKVsxXTtcbiAgICBjb25zdCBkZWZhdWx0RGVwbG95UGF0aCA9IGRlcGxveVBhdGgucmVwbGFjZSgvKF5cXHMqKXwoXFxzKiQpL2csICcnKSArICcvJztcbiAgICBtZXJnZUFsbGZpbGVGbG93KGFwcENvbmZpZywgQkFTRV9QQVRILCBXT1JLX1BBVEgsIGRlZmF1bHREZXBsb3lQYXRoLCBTV0FOX0NPUkVfUEFUSCwgZmFsc2UsIGRlZmF1bHRPcHRpb25zLCBlcnJvckZuKTtcbn1cblxuZnVuY3Rpb24gcmVtb3ZlT2xkT3V0cHV0KHBhdGgpIHtcbiAgICBsZXQgZmlsZXMgPSBbXTtcbiAgICBpZihmcy5leGlzdHNTeW5jKHBhdGgpKSB7XG4gICAgICAgIGZpbGVzID0gZnMucmVhZGRpclN5bmMocGF0aCk7XG4gICAgICAgIGZpbGVzLmZvckVhY2goZnVuY3Rpb24oZmlsZSwgaW5kZXgpIHtcbiAgICAgICAgICAgIGxldCBjdXJQYXRoID0gcGF0aEpvaW4ocGF0aCwgZmlsZSk7XG4gICAgICAgICAgICBpZihmcy5zdGF0U3luYyhjdXJQYXRoKS5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgICAgICAgcmVtb3ZlT2xkT3V0cHV0KGN1clBhdGgpOyAgXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZzLnVubGlua1N5bmMoY3VyUGF0aCk7ICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGZzLnJtZGlyU3luYyhwYXRoKTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIHJlc2V0TG9nRXZlbnQoKSB7XG4gICAgT2JqZWN0LmtleXMoZmluaXNoT2JqKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgIGZpbmlzaE9ialtrZXldID0gMDtcbiAgICB9KTtcbiAgICBPYmplY3Qua2V5cyhyZWNvcmRPYmpbJ2RldmVsb3BlciddKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgIHJlY29yZE9ialsnZGV2ZWxvcGVyJ11ba2V5XSA9IDA7XG4gICAgfSk7XG4gICAgT2JqZWN0LmtleXMocHJvY2Vzc2lvbk9iaikuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICBwcm9jZXNzaW9uT2JqW2tleV0gPSBmYWxzZTtcbiAgICB9KTtcbn1cblxuaWYgKCFDT01NQU5ELmxlbmd0aCkge1xuICAgIHJlbW92ZU9sZE91dHB1dChPVVRQVVQpO1xuICAgIGxldCBvcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgZGVmYXVsdE9wdGlvbnMsIHtcbiAgICAgICAgaHRtbFJlcGxhY2VWYXJpYWJsZXM6IHt9XG4gICAgfSk7XG4gICAgaWYgKENPTVBJTEVEX0NPUkVfUEFUSCkge1xuICAgICAgICBvcHRpb25zLmh0bWxSZXBsYWNlVmFyaWFibGVzWyd7I3N3YW5Db3JlUGF0aCN9J10gPSBDT01QSUxFRF9DT1JFX1BBVEg7XG4gICAgfVxuICAgIGlmIChTQU5fREVWX0hPT0spIHtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihvcHRpb25zLmh0bWxSZXBsYWNlVmFyaWFibGVzLCB7XG4gICAgICAgICAgICAnPCEtLSBzd2FuIG1hc3RlciBob29rIC0tPic6ICc8c2NyaXB0IHR5cGU9XCJ0ZXh0L2phdmFzY3JpcHRcIiBzcmM9XCIuLi9zd2FuLWRldmhvb2svbWFzdGVyLmpzXCI+PC9zY3JpcHQ+JyxcbiAgICAgICAgICAgICc8IS0tIHN3YW4gc2xhdmUgaG9vayAtLT4nOiAnPHNjcmlwdCB0eXBlPVwidGV4dC9qYXZhc2NyaXB0XCIgc3JjPVwiLi4vc3dhbi1kZXZob29rL3NsYXZlLmpzXCI+PC9zY3JpcHQ+J1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgbWVyZ2VBbGxmaWxlRmxvdyhhcHBDb25maWcsIEJBU0VfUEFUSCwgV09SS19QQVRILCBPVVRQVVQsIFNXQU5fQ09SRV9QQVRILCB0cnVlLCBvcHRpb25zLCBlcnJvckZuKTtcbn0gZWxzZSBpZiAoQ09NTUFORC5pbmRleE9mKCd3YXRjaCcpICE9PSAtMSkge1xuICAgIHJlbW92ZU9sZE91dHB1dChPVVRQVVQpO1xuICAgIGxldCBpZ25vcmVEaXIgPSBuZXcgUmVnRXhwKGAke09VVFBVVH1gKTtcbiAgICB3YXRjaC53YXRjaFRyZWUoV09SS19QQVRILCB3YXRjaE9wdGlvbnMsIGZ1bmN0aW9uIChtb2RGaWxlLCBjdXJyLCBwcmV2KSB7XG4gICAgICAgIHJlc2V0TG9nRXZlbnQoKTtcbiAgICAgICAgbWVyZ2VBbGxmaWxlRmxvdyhhcHBDb25maWcsIEJBU0VfUEFUSCwgV09SS19QQVRILCBPVVRQVVQsIFNXQU5fQ09SRV9QQVRILCB0cnVlLCBkZWZhdWx0T3B0aW9ucywgZXJyb3JGbik7XG4gICAgfSk7XG59IGVsc2UgaWYgKENPTU1BTkQuaW5kZXhPZignd2F0Y2hyZW1vdGUnKSAhPT0gLTEpIHtcbiAgICBsZXQgaWdub3JlRGlyID0gbmV3IFJlZ0V4cChgJHtPVVRQVVR9YCk7XG4gICAgd2F0Y2gud2F0Y2hUcmVlKFdPUktfUEFUSCwgd2F0Y2hPcHRpb25zLCBmdW5jdGlvbiAobW9kRmlsZSwgY3VyciwgcHJldikge1xuICAgICAgICB1c2VyQ29kZVJlbW90ZURlcGxveSgpO1xuICAgIH0pO1xufSBlbHNlIGlmIChDT01NQU5ELmluZGV4T2YoJ3VzZXJDb2RlUmVtb3RlRGVwbG95JykgIT09IC0xKSB7XG4gICAgdXNlckNvZGVSZW1vdGVEZXBsb3koKTtcbn0gZWxzZSBpZiAoQ09NTUFORC5pbmRleE9mKCdjb21waWxlVXNlckNvZGUnKSAhPT0gLTEpIHtcbiAgICBtZXJnZUFsbGZpbGVGbG93KGFwcENvbmZpZywgQkFTRV9QQVRILCBXT1JLX1BBVEgsIE9VVFBVVCwgU1dBTl9DT1JFX1BBVEgsIGZhbHNlLCBkZWZhdWx0T3B0aW9ucywgZXJyb3JGbik7XG59IGVsc2UgaWYgKENPTU1BTkQuaW5kZXhPZignb2xkUGFjaycpICE9PSAtMSkge1xuICAgIGxldCBjb3JlUGF0aCA9IGZzLnJlYWRGaWxlU3luYygnbXlkZXYnLCAndXRmLTgnKTtcbiAgICBjb3JlUGF0aCA9IC9cXHMqY29yZVBhdGhcXHMqPSguKikvZy5leGVjKGNvcmVQYXRoKVsxXTtcbiAgICBjb25zdCBzd2FuQ29yZVBhdGggPSBjb3JlUGF0aC5yZXBsYWNlKC8oXlxccyopfChcXHMqJCkvZywgJycpICsgJy8nO1xuICAgIGNvbnN0IG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCBkZWZhdWx0T3B0aW9ucywge1xuICAgICAgICBodG1sUmVwbGFjZVZhcmlhYmxlczoge1xuICAgICAgICAgICAgJ3sjc3dhbkNvcmVQYXRoI30nOiBzd2FuQ29yZVBhdGhcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIG1lcmdlQWxsZmlsZUZsb3coYXBwQ29uZmlnLCBCQVNFX1BBVEgsIFdPUktfUEFUSCwgT1VUUFVULCBTV0FOX0NPUkVfUEFUSCwgdHJ1ZSwgb3B0aW9ucywgZXJyb3JGbik7XG59XG4iXX0=